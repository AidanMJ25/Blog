name: PR Post Preview (Hugo)
on:
  pull_request:
    types: [opened, synchronize, reopened]
permissions:
  contents: read
  pages: write
  id-token: write
  pull-requests: write
concurrency:
  group: "hugo-post-preview-${{ github.event.number }}"
  cancel-in-progress: true
jobs:
  preview:
    runs-on: ubuntu-latest
    env:
      PREVIEW_ROOT: previews/pr-${{ github.event.number }}
    steps:
      - uses: actions/checkout@v4
        with: { submodules: true, fetch-depth: 0 }
      - uses: peaceiris/actions-hugo@v3
        with: { hugo-version: 'latest', extended: true }

      - name: Detect post dir
        id: post
        run: |
          CHANGED="$(git diff --name-only origin/${{ github.base_ref }}...HEAD)"
          POST_DIR="$(echo "$CHANGED" | grep -E '^content/posts/[^/]+/' | awk -F/ '{print $1"/"$2"/"$3"/"}' | head -n1)"
          echo "postdir=$POST_DIR" >> $GITHUB_OUTPUT

      - name: Prep content
        run: |
          mkdir -p _preview_content
          rsync -a "${{ steps.post.outputs.postdir }}" "_preview_content/${{ steps.post.outputs.postdir }}"
          cat > preview.hugo.toml <<'EOF'
          disableKinds = ["home","section","taxonomy","term","RSS","sitemap","robotsTXT","404"]
          [markup.goldmark.renderer]
            unsafe = true
          EOF

      - name: Build Hugo
        run: |
          DEST="public/${{ env.PREVIEW_ROOT }}"
          hugo --minify \
               --config preview.hugo.toml \
               --baseURL="/${{ env.PREVIEW_ROOT }}/" \
               --contentDir _preview_content/content \
               --destination "$DEST" \
               --buildDrafts --buildFuture

      - uses: actions/upload-pages-artifact@v3
        with: { path: ./public }
      - uses: actions/deploy-pages@v4

      - name: Comment link
        env: { GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }} }
        run: |
          OWNER="${{ github.repository_owner }}"
          REPO="${{ github.event.repository.name }}"
          SLUG="$(basename '${{ steps.post.outputs.postdir }}')"
          # project site URL (exact repo casing):
          BASE="https://www.aidanmaurinjones.com"
          URL="$BASE/${{ env.PREVIEW_ROOT }}/posts/$SLUG/"
          jq -n --arg body "ðŸ” **Post Preview:** $URL" '{body:$body}' \
          | curl -s -H "Authorization: Bearer $GITHUB_TOKEN" \
                 -H "Accept: application/vnd.github+json" \
                 "https://api.github.com/repos/${OWNER}/${REPO}/issues/${{ github.event.number }}/comments" \
                 -d @-